<html>

<head>
	<title>JournalMap API Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<script src="heatmap.js-2.0/build/heatmap.js"></script>
    <script src="heatmap.js-2.0/plugins/leaflet-heatmap.js"></script>

</head>

<body>
<h2>Test HeatMap Example for JournalMap</h2>

<div id="container" style="height:410px; width:610px;border:thin solid black;box-shadow: 5px 5px 2px #888888">
<div id="jmap" style="height:400px; width:600px" ></div>
</div>


<script>
	var data; // a global to store the json response
	var articles_url; // global to store articles URL for the pub.
	var articles; //global to store the articles set
	var pubName = "Journal of Arid Environments";
	var pubID = 1;
	var centerLat = 0;
	var centerLon = 0;
	var Zoom = 1;
	var apikey = "PjFRefUzFYzFCvshie8Q";

// Hit the publication endpoint and get the URL for the articles.
d3.xhr("https://www.journalmap.org/api/publications/1.json?key="+apikey+"&version=1.0", function(error, json) {
	if (error) return console.warn(error);
	data = JSON.parse(json.response);
	window.articles_url = (data.articles_url);
	console.log(window.articles_url);
});

	// Hit the articles endpoint with the articles URL, loop over all pages and get the article locations.
d3.xhr(window.articles_url, function(error, json) {
		  var page = 1;
		  window.pages = json.getResponseHeader('X-Pages');
});

		  while(page < pages+1) {   // Iterate over all the pages
			data = JSON.parse(json.response);
			articles = data.articles;
			console.log(articles);
			page += 1;
			
		  };


	var coords = [];

	  for (i=0;i<articles.length;i++) {
	  	var locations = articles[i].locations;
	  	for (j=0;j<locations.length;j++) {
	  		// console.log(locations[j].latitude+', '+locations[j].longitude);
	  		var entry = {'lat': locations[j].latitude,'lng': locations[j].longitude,'count': 1};
	  		coords.push(entry);
	  	}
	  }
	  var heatData = { max: 8, data: coords };
	  
	  var baseLayer = L.tileLayer(
		  'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
			attribution: '...',
			maxZoom: 18
		  }
		);

		var cfg = {
		  // radius should be small ONLY if scaleRadius is true (or small radius is intended)
		  // if scaleRadius is false it will be the constant radius used in pixels
		  "radius": 4,
		  "maxOpacity": .8, 
		  // scales the radius based on map zoom
		  "scaleRadius": true, 
		  // if set to false the heatmap uses the global maximum for colorization
		  // if activated: uses the data maximum within the current map boundaries 
		  //   (there will always be a red spot with useLocalExtremas true)
		  "useLocalExtrema": true,
		  // which field name in your data represents the latitude - default "lat"
		  latField: 'lat',
		  // which field name in your data represents the longitude - default "lng"
		  lngField: 'lng',
		  // which field name in your data represents the data value - default "value"
		  valueField: 'count'
		};


		var heatmapLayer = new HeatmapOverlay(cfg);

		var map = new L.Map('jmap', {
		  center: new L.LatLng(centerLat, centerLon),
		  zoom: Zoom,
		  layers: [baseLayer, heatmapLayer]
		});

		heatmapLayer.setData(heatData);
	  


</script>